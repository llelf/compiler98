include Makefile.inc

THISLIB = FFI

SRCS	= \
	Addr.hs ForeignObj.hs Ptr.hs ShowsIntBase.hs StablePtr.hs

NotYetSRCS = Int.hs Word.hs


OBJDIR = ${BUILDDIR}/${OBJ}/prelude/${THISLIB}
MAINSRC = ${THISLIB}.hs

OBJS = $(patsubst %.hs,${OBJDIR}/%.o,${SRCS})
MAINOBJ = $(patsubst %.hs,${OBJDIR}/%.o,${MAINSRC})
CFILES = $(patsubst %.hs,%.c,${SRCS})
MAINCFILE = $(patsubst %.hs,%.c,${MAINSRC})
HIFILES = $(patsubst %.hs, %.hi, ${SRCS} ${MAINSRC})

PARTFLAGS = -part 		# -prelude -redefine
LIBFLAGS  = +CTS -lib -CTS -P../IOExtras/ -P../LowB/


all:  ${OBJS} ${MAINOBJ}
boot: ${OBJS} ${MAINOBJ}
cfiles: ${CFILES} ${MAINCFILE}
fromC:
	$(HC) -c -d $(OBJDIR) ${CFILES} ${MAINCFILE}
${OBJDIR}:
	mkdir -p ${OBJDIR}
objdir: ${OBJDIR}
clean:
	rm -f ${OBJDIR}/*.o ${HIFILES} *.o *.c *.s



${OBJS}: ${OBJDIR}/%.o : %.hs
	$(HC) -c $(HFLAGS) $(PARTFLAGS) -o $@ $<
${MAINOBJ}: ${OBJS} ${MAINSRC} ../IOExtras/FixIO.hi
	$(HC) -c $(HFLAGS) $(LIBFLAGS) -o $@ ${MAINSRC}

${CFILES} : %.c : %.hs
	$(HC) -C $(HFLAGS) $<
${MAINCFILE}: %.c : %.hs
	$(HC) -C $(HFLAGS) ${LIBFLAGS} $<

.SUFFIXES: .hs .o .c .hi

# I know that they depoend on .hi, but make is stupid :-(

# dependencies generated by hmake -Md:
# (and hacked by MW)
${OBJDIR}/Addr.o: ${OBJDIR}/ShowsIntBase.o 


## Yucky .hi stuff to deal with mutual dependencies.

IOHIFILES =  FixIO UnsafePerformIO
IOHIS     = $(patsubst %,../IOExtras/%.hi,${IOHIFILES})

${IOHIS}: ../IOExtras/%.hi : ../IOExtras/%.hs
	cd ../IOExtras; ${MAKE} $@

../IOExtras/FixIO.hi: ../IOExtras/UnsafePerformIO.hi

